<!DOCTYPE html>
<html lang="en">

<head>
    <title>Micro Project Work</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://login2explore.com/jpdb/resources/js/0.0.3/jpdb-commons.js"></script>
</head>

<body>
    <div class="container">
        <h2>Student Enrollment Form</h2>
        <form id="stuForm" method="post">
            <div class="form-group">
                <span><label for="stuId">Roll-No:</label> <label id="stuIdMsg"> </label></span>
                <input type="text" class="form-control" onchange="getStu()" name="stuId" id="stuId"
                    placeholder="Enter Roll-No" required />
            </div>

            <div class="form-group">
                <label for="stuName">Student Full Name:</label>
                <input type="text" class="form-control" id="stuName" placeholder="Enter Full Name" name="stuName" />
            </div>

            <div class="form-group">
                <label for="stuClass">Class:</label>
                <input type="text" class="form-control" id="stuClass" placeholder="Enter Class" name="stuClass" />
            </div>

            <div class="form-group">
                <label for="stuDOB">Birth-Date:</label>
                <input type="date" class="form-control" id="stuDOB" placeholder="Enter Birth-Date" name="stuDOB" />
            </div>

            <div class="form-group">
                <label for="stuAddress">Address:</label>
                <input type="text" class="form-control" id="stuAddress" placeholder="Enter Address" name="stuAddress" />
            </div>

            <div class="form-group">
                <label for="stuEnrollDate">Enrollment-Date:</label>
                <input type="date" class="form-control" id="stuEnrollDate" placeholder="Enter Enrollment-Date"
                    name="stuEnrollDate" />
            </div>

            <input type="button" class="btn btn-primary" id="empSave" value="Save" onclick="saveData();" />
            <input type="button" class="btn btn-primary" id="empChange" value="Update" onclick="changeData();" />
            <input type="button" class="btn btn-primary" id="empReset" value="Reset" onClick="resetForm()" />
        </form>
    </div>

    <script>
        // Validate and collect form data
        function validateAndGetFormData() {
            var stuIdVar = $("#stuId").val();
            if (stuIdVar === "") {
                alert("Student Roll-No Required Value");
                $("#stuId").focus();
                return "";
            }
            var stuNameVar = $("#stuName").val();
            if (stuNameVar === "") {
                alert("Student Name is Required Value");
                $("#stuName").focus();
                return "";
            }
            var stuClassVar = $("#stuClass").val();
            if (stuClassVar === "") {
                alert("Student Class is Required Value");
                $("#stuClass").focus();
                return "";
            }

            var stuDOBVar = $("#stuDOB").val();
            if (stuDOBVar === "") {
                alert("Student Birth-Date is Required Value");
                $("stuDOB").focus();
                return "";
            }

            var stuAddressVar = $("#stuAddress").val();
            if (stuAddressVar === "") {
                alert("Student Address is Required Value");
                $("#stuAddress").focus();
                return "";
            }

            var stuEnrollDateVar = $("stuEnrollDate").val();
            if (stuEnrollDateVar === "") {
                alert("Student Enrollment-Date is Required Value");
                $("stuEnrollDate").focus();
                return "";
            }

            var jsonStrObj = {
                stuId: stuIdVar,
                stuName: stuNameVar,
                stuClass: stuClassVar,
                stuDOB: stuDOBVar,
                stuAddress: stuAddressVar,
                stuEnrollDate: stuEnrollDateVar,
            };
            return JSON.stringify(jsonStrObj);
        }

        // Prepare JSON object with student id
        function getstuIdASJsonObj(stuId) {
            var jsonStr = {
                id: stuId,
            };
            return JSON.stringify(jsonStr);
        }

        // Fetch student data from the database
        function getStu() {
            var stuIdJsonObj = getstuIdASJsonObj($("#stuId").val());
            var getRequest = createGET_BY_KEYRequest(
                connToken,
                stuDBName,
                stuRelationName,
                stuIdJsonObj
            );
            jQuery.ajaxSetup({ async: false });
            var resJsonObj = executeCommandAtGivenBaseUrl(
                getRequest,
                jpdbBaseURL,
                jpdbURL
            );
            jQuery.ajaxSetup({ async: true });

            if (resJsonObj.status === 400) {
                // If the student does not exist, prepare for saving a new student
                $("#empSave").prop("disabled", false);
                $("#empChange").prop("disabled", true);
                $("#empReset").prop("disabled", false);
                $("#stuId").focus();
            } else if (resJsonObj.status === 200) {
                // If the student exists, allow update with the existing stuId
                $("#stuId").prop("disabled", true); // Disable the Roll-No field for updates
                fillData(resJsonObj); // Fill the form with the existing student data
                $("#empChange").prop("disabled", false); // Enable the update button
                $("#empReset").prop("disabled", false); // Enable the reset button
                localStorage.setItem("recno", resJsonObj.record_no); // Store the record number for updates
            }
        }

        // Reset form data
        function resetForm() {
            $("#stuId").val("");
            $("#stuName").val("");
            $("#stuClass").val("");
            $("#stuDOB").val("");
            $("#stuAddress").val("");
            $("#stuEnrollDate").val("");
            $("#stuId").focus();
        }

        // Save new student data
        function saveData() {
            var jsonStr = validateAndGetFormData();
            if (jsonStr === "") {
                return;
            }

            // Check if the student already exists by stuId
            var stuId = $("#stuId").val();
            var stuIdJsonObj = getstuIdASJsonObj(stuId); // Check for existing student by stuId
            var getRequest = createGET_BY_KEYRequest(
                connToken,
                stuDBName,
                stuRelationName,
                stuIdJsonObj
            );

            jQuery.ajaxSetup({ async: false });
            var resJsonObj = executeCommandAtGivenBaseUrl(
                getRequest,
                jpdbBaseURL,
                jpdbURL
            );
            jQuery.ajaxSetup({ async: true });

            if (resJsonObj.status === 200) {
                // If the stuId already exists, show a message and prevent saving
                alert("Student with Roll-No " + stuId + " already exists.");
                $("#stuId").focus();
                return;
            }

            // If the stuId is unique, save the new student record
            var putReqStr = createPUTRequest(
                "90934454|-31949228826910874|90956937", // API token for authentication
                jsonStr,
                "SCHOOL-DB",
                "STUDENT-TABLE"
            );

            jQuery.ajaxSetup({ async: false });
            var resultObj = executeCommandAtGivenBaseUrl(
                putReqStr,
                "http://api.login2explore.com:5577",
                "/api/iml"
            );
            jQuery.ajaxSetup({ async: true });

            alert(JSON.stringify(resultObj)); // Show the result of the save operation
            resetForm(); // Reset the form after saving
        }

        // Change/update student data
        function changeData() {
            $("#empChange").prop("disabled", true);

            // Get the updated data from the form
            var jsonChg = validateAndGetFormData();
            if (jsonChg === "") {
                return;
            }

            var recordNo = localStorage.getItem("recno"); // Get the record number from localStorage
            if (!recordNo) {
                alert("Record number is not available.");
                return;
            }

            // Prepare the update request with the necessary parameters
            var updateRequest = createUPDATERecordRequest(
                "90934454|-31949228826910874|90956937", // The token (API authentication)
                jsonChg,
                "SCHOOL-DB",
                "STUDENT-TABLE",
                recordNo // Use recordNo to identify the record for updating
            );

            jQuery.ajaxSetup({ async: false });
            var resJsonObj = executeCommandAtGivenBaseUrl(updateRequest, jpdbBaseURL, jpdbURL);
            jQuery.ajaxSetup({ async: true });

            if (resJsonObj.status === 200) {
                alert("Data updated successfully!");
                resetForm();
                $("#stuId").focus();
            } else {
                alert("Failed to update data.");
            }
        }

    </script>
</body>

</html>